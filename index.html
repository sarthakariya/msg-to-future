<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Treasured Time Capsule</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Cormorant+Garamond:wght@400;700&family=Gentium+Plus:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
    
    <style>
        /* Define a harmonious color palette and shadow effects */
        :root {
            --soft-pink-bg: #fce4ec; /* Very light, soft pink for background */
            --warm-pink: #f48fb1; /* A slightly deeper, inviting pink */
            --brown-note: #fdf6e3; /* Creamy, parchment-like background for notes */
            --dark-brown-text: #4e342e; /* Rich, deep brown for primary text */
            --light-brown-text: #795548; /* Softer brown for secondary text */
            --accent-gold: #ffd700; /* Subtle gold for special highlights */
            --shadow-light: 0 4px 10px rgba(0, 0, 0, 0.08);
            --shadow-medium: 0 8px 20px rgba(0, 0, 0, 0.12);
            --transition-duration: 0.3s;
            --border-radius-input: 8px; /* Kept for input fields */
        }

        /* --- Global & Background Styles --- */
        body {
            font-family: 'Gentium Plus', serif; /* Elegant, classic serif font */
            background-color: var(--soft-pink-bg);
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to top for proper scrolling */
            min-height: 100vh;
            margin: 0;
            color: var(--dark-brown-text);
            line-height: 1.7; /* Enhanced line height for readability */
            padding: 30px; /* Generous overall padding */
            box-sizing: border-box;
            overflow-y: auto; /* Enable scrolling for content overflow */
            position: relative; /* Needed for absolute positioned children */
            /* Added a subtle background pattern */
            background-image: url('https://www.transparenttextures.com/patterns/cream-pixels.png'); 
            background-repeat: repeat;
            background-blend-mode: multiply; /* Blends pattern nicely with background color */
        }

        /* Heart Animation Background */
        .heart-animation-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
            z-index: 0; /* Ensures it stays behind content */
        }

        .heart {
            color: rgba(244, 172, 183, 0.5); /* Muted, transparent heart color */
            font-size: 1.5em; /* Larger hearts */
            position: absolute;
            animation: floatAndTwinkle 8s infinite ease-in-out;
            opacity: 0; /* Start hidden */
            text-shadow: 0 0 8px rgba(244, 172, 183, 0.8); /* Subtle glow */
        }

        @keyframes floatAndTwinkle {
            0% { transform: translateY(0px) scale(0.5); opacity: 0; }
            20% { opacity: 0.6; transform: translateY(-20px) scale(1); }
            80% { opacity: 0.3; transform: translateY(-80px) scale(0.8); }
            100% { transform: translateY(-100px) scale(0.5); opacity: 0; }
        }

        /* Coffee Steam Animation */
        .coffee-animation-bg {
            position: absolute;
            bottom: 0px; /* Aligned to bottom of viewport */
            left: 5%; /* From the left edge */
            font-size: 3em; /* Larger coffee cup */
            color: rgba(160, 82, 45, 0.6); /* Semi-transparent coffee color */
            opacity: 0.7;
            pointer-events: none;
            z-index: 0;
            animation: coffeeFadeIn 2s ease-out forwards; /* Fade in with the page */
        }

        .steam-puff {
            position: absolute;
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 50%;
            animation: steamPuff 3s infinite ease-out;
            opacity: 0;
            box-shadow: 0 0 10px rgba(255,255,255,0.5);
        }

        @keyframes coffeeFadeIn {
            0% { opacity: 0; transform: translateY(50px); }
            100% { opacity: 0.7; transform: translateY(0); }
        }

        @keyframes steamPuff {
            0% { transform: scale(0.2) translateY(0); opacity: 0; }
            20% { opacity: 0.8; }
            100% { transform: scale(1.5) translateY(-80px); opacity: 0; }
        }

        /* --- Main Container & Overall Layout --- */
        .container {
            background-color: white;
            padding: 50px; /* More padding for a grander feel */
            /* More elegant, organic border-radius */
            border-radius: 35px 70px 45px 80px / 80px 45px 70px 35px;
            box-shadow: var(--shadow-medium); /* Prominent shadow for depth */
            width: 100%;
            max-width: 750px; /* Wider container for spaciousness */
            text-align: center;
            box-sizing: border-box;
            position: relative;
            z-index: 1; /* Ensures it's above background animations */
            margin-top: 30px;
            margin-bottom: 30px;
            border: 1px solid rgba(244, 172, 183, 0.4); /* Subtle pink border */
            animation: containerEntry 1s ease-out forwards;
            /* Added main card texture - more pronounced */
            background-image: url('https://www.transparenttextures.com/patterns/graphy.png'); /* A subtle graph paper texture - changed */
            background-blend-mode: overlay; /* Blends nicely with white background */
            background-size: 100px 100px; /* Adjust size of the pattern */
            background-attachment: fixed; /* Keeps texture fixed during scroll */
        }

        @keyframes containerEntry {
            0% { opacity: 0; transform: translateY(30px) scale(0.95); }
            100% { opacity: 1; transform: translateY(0) scale(1); }
        }

        /* --- Typography --- */
        h1 {
            font-family: 'Playfair Display', serif; /* Elegant heading font */
            color: var(--dark-brown-text);
            margin-bottom: 25px;
            font-size: 2.8em; /* Impactful size */
            font-weight: 700;
            line-height: 1.2;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.05); /* Subtle text shadow */
        }

        .greeting {
            font-family: 'Cormorant Garamond', serif; /* A graceful, italicized greeting font */
            font-style: italic;
            font-weight: 700;
            font-size: 2.4em; /* Prominent greeting */
            color: var(--warm-pink);
            margin-bottom: 35px;
            text-shadow: 1px 1px 5px rgba(244, 172, 183, 0.7); /* Soft glow for greeting */
            animation: greetingPulse 3s infinite ease-in-out alternate;
        }

        @keyframes greetingPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        p {
            margin-bottom: 25px;
            color: var(--light-brown-text);
            font-size: 1.05em;
            max-width: 650px;
            margin-left: auto;
            margin-right: auto;
            line-height: 1.8;
        }
        
        .instruction-text {
            font-weight: 600;
            color: var(--warm-pink);
            font-size: 1.1em;
        }

        /* --- Form Elements --- */
        form {
            display: flex;
            flex-direction: column;
            gap: 22px; /* Consistent spacing */
            margin-top: 30px;
            align-items: center; /* Center form elements */
        }

        label {
            text-align: left;
            font-weight: 700;
            color: var(--dark-brown-text);
            font-size: 1.05em;
            margin-bottom: 5px;
            width: 100%; /* Ensure label takes full width for alignment */
            max-width: 400px; /* Match max-width of inputs */
        }

        textarea,
        input[type="date"],
        input[type="text"] {
            width: calc(100% - 24px); /* Account for padding */
            padding: 12px;
            border: 1px solid var(--warm-pink); /* Pink border */
            border-radius: var(--border-radius-input); /* Softly rounded input fields */
            font-size: 1em;
            font-family: 'Gentium Plus', serif; /* Consistent elegant font */
            transition: border-color var(--transition-duration) ease, box-shadow var(--transition-duration) ease;
            background-color: #fffaf0; /* Slightly off-white for a warm feel */
            color: var(--dark-brown-text);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05); /* Subtle inner shadow */
            appearance: none; /* Reset default browser styles */
            -webkit-appearance: none;
            max-width: 400px; /* Constrain width of inputs */
        }

        textarea::placeholder,
        input[type="date"]::placeholder,
        input[type="text"]::placeholder {
            font-family: 'Gentium Plus', serif;
            color: rgba(121, 85, 72, 0.6); /* Muted brown placeholder */
        }

        textarea:focus,
        input[type="date"]:focus,
        input[type="text"]:focus {
            border-color: var(--dark-brown-text);
            box-shadow: 0 0 0 3px rgba(244, 172, 183, 0.5); /* Pink glow on focus */
            background-color: white;
            outline: none;
        }

        textarea {
            resize: vertical;
            min-height: 180px; /* Adequate height for notes */
        }
        
        /* Custom styling for date input icon - improved for all devices */
        input[type="date"] {
            position: relative; /* Needed for custom picker indicator */
            padding-right: 40px; /* Make space for custom icon */
        }
        input[type="date"]::-webkit-calendar-picker-indicator {
            background: transparent;
            color: transparent; /* Hide default icon */
            cursor: pointer;
            width: 100%; /* Make clickable area wide */
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
        }
        /* Fallback for browsers not supporting ::-webkit-calendar-picker-indicator or for custom icon */
        input[type="date"]::after {
            content: "🗓️"; /* Calendar emoji as custom icon */
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none; /* Allows click to pass through to picker */
            color: var(--light-brown-text);
            font-size: 1.2em;
        }

        /* --- Unique Secret Code Input Style (shorter width) --- */
        #secretCodeInput, #retrieveSecretCodeInput {
            border: 2px solid var(--warm-pink);
            background-color: #fff8f5; /* Lighter, more distinct background */
            box-shadow: inset 0 0 5px rgba(244, 172, 183, 0.3); /* Inner glow */
            padding-left: 45px; /* Space for icon */
            position: relative; /* For the pseudo-element icon */
            max-width: 300px; /* Shorter width for secret code inputs */
        }
        #secretCodeInput::before, #retrieveSecretCodeInput::before {
            content: '🔑'; /* Key emoji as icon */
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.3em;
            color: var(--dark-brown-text);
        }
        #secretCodeInput:focus, #retrieveSecretCodeInput:focus {
            border-color: var(--dark-brown-text);
            box-shadow: 0 0 0 4px rgba(244, 172, 183, 0.7), inset 0 0 5px rgba(244, 172, 183, 0.5); /* Stronger glow */
        }


        /* --- Buttons --- */
        button {
            background-color: var(--warm-pink);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: var(--border-radius-input);
            cursor: pointer;
            font-size: 1.2em;
            font-weight: bold;
            transition: background-color var(--transition-duration) ease, transform 0.15s ease, box-shadow var(--transition-duration) ease;
            letter-spacing: 0.5px;
            box-shadow: var(--shadow-light);
            max-width: 300px; /* Constrain button width */
            width: 100%;
        }

        button:hover {
            background-color: #e6518f; /* Slightly darker pink on hover */
            transform: translateY(-2px); /* Subtle lift */
            box-shadow: var(--shadow-medium);
        }

        button:active {
            transform: translateY(0);
            box-shadow: var(--shadow-light);
            background-color: #d1427c;
        }

        /* --- Status Messages --- */
        #statusMessage {
            margin-top: 30px;
            padding: 18px;
            border-radius: var(--border-radius-input);
            font-weight: 600;
            font-size: 1em;
            text-align: center;
            opacity: 0;
            max-height: 0;
            overflow: hidden;
            transition: opacity 0.5s ease-out, max-height 0.5s ease-out, padding 0.5s ease-out; /* Smooth transition */
            background-color: #e8f5e9; /* Light green for success */
            color: #2e7d32; /* Dark green text */
            border: 1px solid #a5d6a7; /* Green border */
            max-width: 600px; /* Constrain width */
            width: 100%;
        }

        #statusMessage.visible {
            opacity: 1;
            max-height: 100px; /* Sufficient height */
            padding: 18px;
            animation: statusFadeIn 0.8s ease-out forwards;
        }

        @keyframes statusFadeIn {
            0% { transform: translateY(-10px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }

        .hidden {
            display: none;
        }

        /* --- Toggle Links (Open Memory Box Button) --- */
        .toggle-link {
            margin-top: 30px;
            font-size: 0.95em;
            color: var(--light-brown-text);
            display: flex; /* Use flex to center button */
            justify-content: center;
            align-items: center;
            gap: 10px; /* Space between text and button */
            flex-wrap: wrap; /* Allow wrapping on small screens */
        }

        #showViewMessage {
            background-color: var(--accent-gold); /* Gold button */
            color: var(--dark-brown-text);
            padding: 12px 25px;
            border-radius: 25px; /* More rounded, pill shape */
            text-decoration: none;
            font-weight: bold;
            font-size: 1.1em;
            transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            display: inline-flex; /* Align icon if added */
            align-items: center;
            gap: 8px;
            white-space: nowrap; /* Prevent text wrap */
        }

        #showViewMessage:hover {
            background-color: #e0b000; /* Darker gold */
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        #showViewMessage:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        }
        
        #showViewMessage::before {
            content: '🗝️'; /* Key emoji as an icon for the button */
            font-size: 1.2em;
        }

        .toggle-link a { /* Existing style for the "create another memory" link */
            color: var(--warm-pink);
            text-decoration: none;
            font-weight: bold;
            transition: color var(--transition-duration) ease;
        }

        .toggle-link a:hover {
            color: var(--dark-brown-text);
            text-decoration: underline;
        }

        /* --- Message Display Area --- */
        #messageDisplayArea {
            min-height: 200px; /* Ensure space even when empty */
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            gap: 18px; /* Spacing between notes */
            padding-top: 10px;
            padding-bottom: 20px;
        }

        .note-card {
            background-color: var(--brown-note); /* Brown page view */
            border: 1px solid #dcd3c5; /* Subtle border for the "page" */
            /* Unique, asymmetrical border-radius for notes */
            border-radius: 15px 50px 20px 40px / 40px 20px 50px 15px;
            padding: 25px; /* Ample padding */
            text-align: left;
            width: 100%;
            box-sizing: border-box;
            box-shadow: var(--shadow-light);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            position: relative; /* For the "fold" effect */
            overflow: hidden;
            opacity: 0; /* Start hidden for animation */
            transform: translateY(20px);
            animation: noteCardEntry 0.6s ease-out forwards;
            max-width: 600px; /* Constrain notes width */
        }
        
        @keyframes noteCardEntry {
            0% { opacity: 0; transform: translateY(20px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        .note-card:hover {
            transform: translateY(-5px); /* Lift slightly on hover */
            box-shadow: var(--shadow-medium);
        }

        /* Top-right folded corner for note card */
        .note-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            border-width: 0 25px 25px 0; /* Adjust size of the fold */
            border-style: solid;
            border-color: #f0f0f0 #f0f0f0 var(--brown-note) var(--brown-note);
            background-color: #f0f0f0; /* Color of the fold */
            box-shadow: -1px 1px 2px rgba(0,0,0,0.1);
            transform: rotate(90deg);
            transform-origin: 100% 0;
            transition: border-color 0.2s ease;
        }

        .note-card:hover::before {
             border-color: #e0e0e0 #e0e0e0 var(--brown-note) var(--brown-note); /* Darken fold on hover */
        }

        .message-content {
            white-space: pre-wrap; /* Preserves line breaks from textarea */
            font-family: 'Cormorant Garamond', serif; /* Elegant font for message content */
            font-style: italic; /* A gentle touch */
            font-size: 1.25em; /* Clear and readable */
            color: var(--dark-brown-text);
            line-height: 1.8;
            margin-bottom: 15px;
            border-left: 3px solid var(--warm-pink); /* Subtle accent line */
            padding-left: 15px;
            margin-left: -15px; /* Adjust for padding */
        }

        .note-date-info {
            font-size: 0.85em;
            color: var(--light-brown-text);
            text-align: right;
            margin-top: 10px;
            font-style: italic;
        }

        /* --- Responsive Adjustments --- */
        @media (max-width: 768px) {
            body {
                padding: 20px;
            }
            .container {
                padding: 35px;
                margin: 15px auto;
                 border-radius: 25px 50px 35px 60px / 60px 35px 50px 25px; /* Adjust for smaller screens */
            }
            h1 {
                font-size: 2.2em;
            }
            .greeting {
                font-size: 2em;
            }
            p {
                font-size: 1em;
            }
            textarea, input[type="date"], input[type="text"] {
                padding: 10px;
                max-width: 100%; /* Allow full width on small screens */
            }
            label {
                max-width: 100%;
            }
            button {
                font-size: 1.1em;
                padding: 12px 25px;
                max-width: 100%;
            }
            .note-card {
                padding: 20px;
                 border-radius: 10px 40px 15px 30px / 30px 15px 40px 10px; /* Adjust for smaller screens */
                max-width: 100%;
            }
            .message-content {
                font-size: 1.1em;
            }
            #showViewMessage {
                font-size: 1em;
                padding: 10px 20px;
            }
            #secretCodeInput, #retrieveSecretCodeInput {
                padding-left: 35px; /* Adjust for smaller screen icon spacing */
                max-width: 100%;
            }
            #secretCodeInput::before, #retrieveSecretCodeInput::before {
                left: 10px;
                font-size: 1.1em;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 15px;
            }
            .container {
                padding: 25px;
                margin: 10px auto;
                 border-radius: 20px 40px 30px 50px / 50px 30px 40px 20px; /* Adjust for smallest screens */
            }
            h1 {
                font-size: 1.8em;
            }
            .greeting {
                font-size: 1.6em;
            }
            p {
                font-size: 0.9em;
            }
            textarea {
                min-height: 150px;
            }
            button {
                font-size: 1em;
                padding: 10px 20px;
            }
            .note-card {
                padding: 15px;
                 border-radius: 8px 30px 12px 25px / 25px 12px 30px 8px; /* Adjust for smallest screens */
            }
            .message-content {
                font-size: 1em;
            }
            .note-card::before { /* Smaller fold */
                border-width: 0 20px 20px 0;
            }
            #showViewMessage {
                font-size: 0.9em;
                padding: 8px 18px;
            }
        }
    </style>
</head>
<body>
    <div class="heart-animation-bg">
        <div class="heart" style="left:10%; top:15%; animation-delay: 0s;">💖</div>
        <div class="heart" style="left:30%; top:40%; animation-delay: 1.5s; font-size: 1.7em;">💖</div>
        <div class="heart" style="left:50%; top:25%; animation-delay: 3s;">💖</div>
        <div class="heart" style="left:70%; top:60%; animation-delay: 4.5s; font-size: 1.2em;">💖</div>
        <div class="heart" style="left:90%; top:10%; animation-delay: 6s;">💖</div>
        <div class="heart" style="left:5%; top:70%; animation-delay: 2.5s; font-size: 1.3em;">💖</div>
        <div class="heart" style="left:65%; top:5%; animation-delay: 5s; font-size: 1.8em;">💖</div>
    </div>
    <div class="coffee-animation-bg">
        ☕
        <div class="steam-puff" style="left: 20%; top: -30%; animation-delay: 0s; width: 15px; height: 15px;"></div>
        <div class="steam-puff" style="left: 60%; top: -45%; animation-delay: 0.5s; width: 20px; height: 20px;"></div>
        <div class="steam-puff" style="left: 40%; top: -60%; animation-delay: 1s; width: 18px; height: 18px;"></div>
    </div>

    <div class="container">
        <h2 id="timeGreeting" class="greeting"></h2>

        <div id="writeMessageSection">
            <h1>Craft a Cherished Note</h1>
            <p>Here, you can pen your special messages and secure them with a unique Secret Code. You may also choose a specific date for these memories to be revealed, or access them instantly.</p>

            <form id="messageForm">
                <label for="secretCodeInput">Your Secret Code:</label>
                <input type="text" id="secretCodeInput" placeholder="e.g., MyPreciousMemory (letters & numbers only)" required pattern="^[a-zA-Z0-9]+$" title="Please use only letters and numbers. No spaces or special characters.">

                <label for="messageContent">Your Treasured Note:</label>
                <textarea id="messageContent" rows="10" placeholder="Type your beautiful words here..."></textarea>

                <label for="deliveryDate">Optional Unveiling Date:</label>
                <input type="date" id="deliveryDate">
                <p style="font-size: 0.9em; color: var(--light-brown-text); margin-top: -15px; margin-bottom: 20px;">Leave this field blank to access your note immediately upon saving.</p>

                <button type="submit">Seal Your Memory in Time</button>
            </form>

            <div id="statusMessage" class="hidden">Your note has been successfully saved!</div>
            
            <p class="toggle-link">
                Ready to reflect on your saved memories? 
                <a href="#" id="showViewMessage">Open Your Memory Box</a>
            </p>
        </div>

        <div id="viewMessageSection" class="hidden">
            <h1>Your Past Notes</h1>
            <p>Kindly enter your Secret Code below to unlock and view your collection of treasured memories.</p>
            <form id="retrieveMessageForm">
                <label for="retrieveSecretCodeInput">Enter Secret Code:</label>
                <input type="text" id="retrieveSecretCodeInput" placeholder="Your Secret Code" required pattern="^[a-zA-Z0-9]+$" title="Please use only letters and numbers. No spaces or special characters.">
                <button type="submit">Reveal Memories</button>
            </form>

            <div id="messageDisplayArea">
                <p id="noMessage" class="hidden">No notes were found for this code, or none are currently ready to be viewed.</p>
                <div id="notesContainer"></div>
            </div>
            <p class="toggle-link"><a href="#" id="showWriteMessage">Wish to create another memory?</a></p>
        </div>
    </div>

    <script type="module">
        // Import the necessary functions from the Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, collection, addDoc, query, getDocs, getDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // Your web app's Firebase configuration - IMPORTANT: REPLACE WITH YOUR ACTUAL FIREBASE CONFIG
        // You can find these values in your Firebase project settings -> "Your apps" -> "Web"
        const firebaseConfig = {
            apiKey: "AIzaSyDSDP55e5_yeoNJNX9Ix6RprkHnO3xsbNA",
            authDomain: "timelessnotesapp.firebaseapp.com",
            projectId: "timelessnotesapp",
            storageBucket: "timelessnotesapp.firebasestorage.app",
            messagingSenderId: "709543240404",
            appId: "1:709543240404:web:fb1c269ddbf6cbcf02d141",
            measurementId: "G-Z0ML78V61B"
        };
        // Initialize Firebase application and Firestore database
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Element References ---
            const timeGreeting = document.getElementById('timeGreeting');
            const writeMessageSection = document.getElementById('writeMessageSection');
            const messageForm = document.getElementById('messageForm');
            const statusMessageDiv = document.getElementById('statusMessage');
            const secretCodeInput = document.getElementById('secretCodeInput');
            const messageContentInput = document.getElementById('messageContent');
            const deliveryDateInput = document.getElementById('deliveryDate');
            const showViewMessageLink = document.getElementById('showViewMessage');
            
            const viewMessageSection = document.getElementById('viewMessageSection');
            const retrieveMessageForm = document.getElementById('retrieveMessageForm');
            const retrieveSecretCodeInput = document.getElementById('retrieveSecretCodeInput');
            const noMessageDiv = document.getElementById('noMessage');
            const notesContainer = document.getElementById('notesContainer'); // Container for multiple notes
            const showWriteMessageLink = document.getElementById('showWriteMessage');

            // --- Time-Based Greeting Function (No "Dearest") ---
            function setTimeGreeting() {
                const hour = new Date().getHours();
                let greeting;
                if (hour >= 5 && hour < 12) {
                    greeting = "Good Morning, My Friend!";
                } else if (hour >= 12 && hour < 18) {
                    greeting = "Good Afternoon, My Friend!";
                } else {
                    greeting = "Good Evening, My Friend!";
                }
                timeGreeting.textContent = greeting;
            }
            setTimeGreeting(); // Call immediately on page load

            // --- Note Saved Status Message Display Function ---
            function showSaveStatus(message) {
                statusMessageDiv.textContent = message;
                statusMessageDiv.classList.add('visible');
                // The warning will automatically disappear after 5 seconds
                setTimeout(() => {
                    statusMessageDiv.classList.remove('visible');
                }, 5000);
            }

            // --- Section Visibility Toggling Functions ---
            function showSection(sectionId) {
                // Hide all sections first
                writeMessageSection.classList.add('hidden');
                viewMessageSection.classList.add('hidden');
                statusMessageDiv.classList.remove('visible'); // Hide status message when switching sections

                if (sectionId === 'write') {
                    writeMessageSection.classList.remove('hidden');
                    messageForm.reset(); // Clear form when navigating to write section
                    // Set min date for deliveryDateInput to today
                    const today = new Date();
                    const minDate = today.toISOString().split('T')[0];
                    deliveryDateInput.setAttribute('min', minDate);
                } else if (sectionId === 'view') {
                    viewMessageSection.classList.remove('hidden');
                    notesContainer.innerHTML = ''; // Clear previously displayed notes
                    noMessageDiv.classList.add('hidden'); // Hide "no message" text initially
                    retrieveSecretCodeInput.value = ''; // Clear secret code input
                }
            }

            // --- Event Listeners for Section Navigation Links ---
            showViewMessageLink.addEventListener('click', (e) => {
                e.preventDefault(); // Prevent default link behavior
                showSection('view');
            });
            showWriteMessageLink.addEventListener('click', (e) => {
                e.preventDefault(); // Prevent default link behavior
                showSection('write');
            });

            // --- Logic for Writing/Storing New Note with Firebase ---
            messageForm.addEventListener('submit', async (event) => {
                event.preventDefault(); // Prevent default form submission

                statusMessageDiv.classList.remove('visible'); // Hide any previous status

                const secretCode = secretCodeInput.value.trim().toLowerCase();
                const messageContent = messageContentInput.value.trim();
                const deliveryDate = deliveryDateInput.value;
                const now = new Date(); // Current date for validation

                // Input validation
                if (!secretCode || !messageContent) {
                    alert('Please ensure both the Secret Code and Your Note fields are filled.');
                    return;
                }
                if (!/^[a-zA-Z0-9]+$/.test(secretCode)) {
                    alert('Your Secret Code should only contain letters and numbers.');
                    return;
                }
                if (deliveryDate) { 
                    const chosenDate = new Date(deliveryDate + 'T00:00:00'); // Ensure date comparison is consistent
                    if (chosenDate < new Date(now.getFullYear(), now.getMonth(), now.getDate())) { 
                        alert('The Unveiling Date cannot be in the past.');
                        return;
                    }
                }

                try {
                    // Create or update the parent document for the secret code
                    const secretCodeDocRef = doc(db, "messages", secretCode);
                    await setDoc(secretCodeDocRef, { lastUpdated: new Date().toISOString() }, { merge: true });

                    // Prepare note data
                    const noteData = {
                        messageContent: messageContent,
                        // Store deliveryDate as null if not provided
                        deliveryDate: deliveryDate || null,
                        // Record creation date for sorting/tracking
                        createdAt: new Date().toISOString().split('T')[0]
                    };

                    // Add the new note to the 'notes' subcollection under the secret code
                    const notesCollectionRef = collection(db, "messages", secretCode, "notes");
                    await addDoc(notesCollectionRef, noteData);

                    // Display success message and clear form
                    showSaveStatus('Your note has been successfully saved!');
                    messageForm.reset();
                    // Reset min date after successful submission
                    const today = new Date();
                    const minDate = today.toISOString().split('T')[0];
                    deliveryDateInput.setAttribute('min', minDate);

                } catch (error) {
                    console.error('Error saving note:', error);
                    alert('An unexpected error occurred while saving your note. Please try again later.');
                }
            });

            // --- Logic for Retrieving and Displaying Multiple Notes from Firebase (with Easter Egg) ---
            retrieveMessageForm.addEventListener('submit', async (event) => {
                event.preventDefault(); // Prevent default form submission

                // Clear previous notes and messages
                notesContainer.innerHTML = '';
                noMessageDiv.classList.add('hidden');
                statusMessageDiv.classList.remove('visible'); // Hide any previous status

                const retrieveCode = retrieveSecretCodeInput.value.trim().toLowerCase();

                // Input validation for retrieval
                if (!retrieveCode) {
                    noMessageDiv.textContent = "Please enter your Secret Code to retrieve notes.";
                    noMessageDiv.classList.remove('hidden');
                    return;
                }
                if (!/^[a-zA-Z0-9]+$/.test(retrieveCode)) {
                    noMessageDiv.textContent = 'The Secret Code should only contain letters and numbers.';
                    noMessageDiv.classList.remove('hidden');
                    return;
                }

                // --- EASTER EGG IMPLEMENTATION ---
                const EASTER_EGG_CODE = "mammamspecialnote"; // Convert to lowercase for comparison
                if (retrieveCode === EASTER_EGG_CODE) {
                    const specialMessage = "Dearest Mammam, this little app was made with love, just like your warm hugs and delicious food! Always thinking of you. ❤️ - Sarthak";
                    const specialNoteCard = document.createElement('div');
                    specialNoteCard.classList.add('note-card');
                    specialNoteCard.style.backgroundColor = '#ffe0b2'; // A special color for Mammam's note
                    specialNoteCard.style.borderColor = '#ffcc80';

                    const messageP = document.createElement('p');
                    messageP.classList.add('message-content');
                    messageP.innerHTML = specialMessage.replace(/\n/g, '<br>');
                    messageP.style.color = '#795548'; // Matching text color

                    const dateInfoP = document.createElement('p');
                    dateInfoP.classList.add('note-date-info');
                    dateInfoP.textContent = "A special message from Sarthak!";
                    dateInfoP.style.color = '#a1887f';

                    specialNoteCard.appendChild(messageP);
                    specialNoteCard.appendChild(dateInfoP);
                    notesContainer.appendChild(specialNoteCard);
                    return; // Stop further processing for the easter egg
                }
                // --- END EASTER EGG ---

                try {
                    // Check if the parent secret code document exists first
                    const secretCodeDocRef = doc(db, "messages", retrieveCode);
                    const secretCodeDocSnap = await getDoc(secretCodeDocRef);

                    if (!secretCodeDocSnap.exists()) {
                        noMessageDiv.textContent = "No notes are associated with this Secret Code. Perhaps you'd like to create one?";
                        noMessageDiv.classList.remove('hidden');
                        return;
                    }

                    // Query the 'notes' subcollection for the given secret code
                    const notesCollectionRef = collection(db, "messages", retrieveCode, "notes");
                    const q = query(notesCollectionRef);
                    const querySnapshot = await getDocs(q);

                    const notes = [];
                    querySnapshot.forEach((doc) => {
                        notes.push({ id: doc.id, ...doc.data() });
                    });

                    if (notes.length > 0) {
                        let hasVisibleNotes = false;
                        const now = new Date();
                        // Sort notes by creation date, most recent first
                        notes.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                        notes.forEach(note => {
                            const deliveryDate = note.deliveryDate ? new Date(note.deliveryDate + 'T00:00:00') : null; // Ensure consistency
                            const createdAtDate = new Date(note.createdAt).toLocaleDateString();

                            // Only display notes that are ready to be unveiled
                            if (!deliveryDate || now >= deliveryDate) {
                                hasVisibleNotes = true;
                                const noteCard = document.createElement('div');
                                noteCard.classList.add('note-card');

                                const messageP = document.createElement('p');
                                messageP.classList.add('message-content');
                                // Use innerHTML and replace newlines with <br> for proper formatting
                                messageP.innerHTML = note.messageContent.replace(/\n/g, '<br>');
                                
                                const dateInfoP = document.createElement('p');
                                dateInfoP.classList.add('note-date-info');
                                dateInfoP.textContent = `Created on: ${createdAtDate}`;
                                
                                noteCard.appendChild(messageP);
                                noteCard.appendChild(dateInfoP);
                                notesContainer.appendChild(noteCard);
                            }
                        });
                        // If notes were found but none are yet ready for viewing
                        if (!hasVisibleNotes && notes.length > 0) { 
                             noMessageDiv.textContent = "All your notes are patiently awaiting their scheduled unveiling dates. None are ready for viewing just yet!";
                             noMessageDiv.classList.remove('hidden');
                        } else if (notes.length === 0) { 
                            // This case should ideally be caught by secretCodeDocSnap.exists(), but as a fallback
                            noMessageDiv.textContent = "No notes were found for this Secret Code. Perhaps you'd like to create one?";
                            noMessageDiv.classList.remove('hidden');
                        }

                    } else {
                        // If the secret code exists, but no notes are under it
                        noMessageDiv.textContent = "No notes were found for this Secret Code. Perhaps you'd like to create one?";
                        noMessageDiv.classList.remove('hidden');
                    }
                } catch (error) {
                    console.error('Error retrieving notes:', error);
                    noMessageDiv.textContent = "An unexpected error occurred while retrieving your notes. Please check your connection or try again later.";
                    noMessageDiv.classList.remove('hidden');
                }
            });
            // --- Initialize (Show write section by default) ---
            showSection('write');
        });
    </script>
</body>
</html>
